- name: AZ Login to Azure using GEN SPN
  shell: >
      az login --service-principal -u "{{ AZURE_RM_CLIENTID_PBIE | mandatory }}" -p "{{ AZURE_RM_SECRET_PBIE | mandatory }}" --tenant "{{ AZURE_RM_TENANTID_PBIE | mandatory }}" ;
      az account set --subscription "{{ var_subscriptionId }}" ;
  no_log: True

- name: =================================================  GET ACCESS TOKENS  =================================================
  block:

    - name: Request Power BI Access Token for Workspace Admin user
      uri:
        url: "https://login.microsoftonline.com/{{ AZURE_RM_TENANTID_PBIE }}/oauth2/token"
        method: "POST"
        return_content: yes
        body: "client_id={{ AZURE_RM_CLIENTID_PBIE }}&client_secret={{ AZURE_RM_SECRET_PBIE | urlencode }}&grant_type=client_credentials&resource=https%3A%2F%2Fanalysis.windows.net%2Fpowerbi%2Fapi"
        status_code: 200,201
        headers:
          Content-Type: "application/x-www-form-urlencoded"
      register: access
      no_log: True

    - name: Get Access Token from response
      set_fact:
        var_APIAccessToken: "{{ (access.content|from_json).access_token }}"
      no_log: True

    - name: Request Power BI Access Token for Management Admin user
      uri:
        url: "https://login.microsoftonline.com/{{ AZURE_RM_TENANTID_PBIE }}/oauth2/token"
        method: "POST"
        return_content: yes
        body: "client_id={{ AZURE_RM_CLIENTID_PBIE }}&client_secret={{ AZURE_RM_SECRET_PBIE | urlencode }}&grant_type=client_credentials&resource=https%3A%2F%2Fmanagement.azure.com"
        status_code: 200,201
        headers:
          Content-Type: "application/x-www-form-urlencoded"
      register: AzureToken
      no_log: True

    - name: Get Access Token from response
      set_fact:
        var_AzureAccessToken: "{{ (AzureToken.content|from_json).access_token }}"
      no_log: True      